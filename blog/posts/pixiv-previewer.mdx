---
title: å¯¹æ²¹çŒ´è„šæœ¬ Pixiv Previewer è¿›è¡ŒäºŒæ¬¡å¼€å‘
date: 2025-03-17
updated: 2025-04-26
timeliness: false
categories:
  - å‰ç«¯å¼€å‘
tags:
  - TypeScript
  - Tampermonkey
  - Pixiv
---

ç¬”è€…çš„ä¸šä½™çˆ±å¥½ä¹‹ä¸€å°±æ˜¯é€› Pixivï¼Œæ”¶è—å¥½çœ‹çš„æ’ç”»ç­‰ä½œå“å¹¶ä¸‹è½½åˆ°æœ¬åœ°ã€‚æ²¹çŒ´è„šæœ¬ Pixiv Previewer åšäº†ä¸¤ä¸ªç¬”è€…å¾ˆå–œæ¬¢çš„ä¾¿åˆ©æ€§å·¥ä½œï¼š

1. **ä½œå“é¢„è§ˆ**ï¼šé¼ æ ‡æ‚¬æµ®åœ¨ä½œå“ç¼©ç•¥å›¾ä¸Šæ—¶è‡ªåŠ¨åœ¨å½“å‰é¡µé¢æ˜¾ç¤ºå¤§å›¾ï¼Œå¿«é€Ÿå†³å®šè¦ä¸è¦ç‚¹è¿›ä½œå“é¡µã€‚
2. **ä½œå“æ’åº**ï¼šä½œå“æœç´¢é¡µå¯ä»¥æŒ‰â€œæ’åºâ€æŒ‰é’®ï¼Œè‡ªåŠ¨è·å–è‹¥å¹²é¡µçš„ä½œå“å¹¶æŒ‰ç…§æ”¶è—æ•°æ’åºï¼Œå¿«é€Ÿç­›é€‰ä¼˜è´¨ä½œå“ã€‚

å‡ºäºçˆ±å¥½ï¼Œç¬”è€…å»[è„šæœ¬ä»“åº“](https://github.com/Ocrosoft/PixivPreviewer)ç¿»é˜…äº†ä¸€ä¸‹æºç ï¼Œè§‰å¾—æœ‰ä¸€äº›å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Œé‚ Fork ä¹‹ï¼Œè¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

## å·¥ç¨‹åŒ–æ”¹é€ 

é¦–å½“å…¶å†²çš„è‡ªç„¶æ˜¯å‰ç«¯é¡¹ç›®å·¥ç¨‹åŒ–æ”¹é€ ã€‚å¤§å¤šæ•°æ²¹çŒ´è„šæœ¬ä»“åº“éƒ½æ˜¯å­¤é›¶é›¶çš„ä¸€ä¸ª JavaScript æ–‡ä»¶ï¼ŒPixiv Previewer ä¹Ÿä¸ä¾‹å¤–ã€‚ç›´æ¥æ‰‹æ“ JavaScript è™½ç„¶å¾ˆä¾¿åˆ©ï¼Œä½†åœ¨é¡¹ç›®é•¿æœŸçš„ç»´æŠ¤å¼€å‘ä¸­å¤šåŠä¼šæ©åŸ‹æ‰è®¸å¤šæœªæ›¾ç•™æ„çš„ Bugï¼ŒåŒæ—¶ç”±äºç¼ºå°‘å…³è”æç¤ºï¼Œå¼€å‘æ•ˆç‡ä¹Ÿä¼šå¤§æ‰“æŠ˜æ‰£ã€‚ä½œä¸ºå‰ç«¯å·¥ç¨‹å¸ˆï¼Œè¿™æ ·å¯æ€•çš„äº‹æƒ…è‡ªç„¶æ˜¯ä¸èƒ½æ¥å—çš„ã€‚

### é€šè¿‡ tsup æ„å»ºé¡¹ç›®

åˆå§‹åŒ– `package.json` ç­‰è¿‡ç¨‹è·³è¿‡ä¸è¡¨ï¼Œæ·»åŠ  TypeScript æ”¯æŒè‡ªç„¶æ˜¯å¯¹é¡¹ç›®è¿›è¡ŒäºŒæ¬¡å¼€å‘çš„å‰ç½®æ­¥éª¤ã€‚ç”±äºæˆ‘ä»¬æœ€åæ„å»ºçš„äº§ç‰©å°†ä½œä¸ºæ²¹çŒ´è„šæœ¬è¿è¡Œï¼Œå³æ‰“åŒ…ä¸ºåº“ï¼Œå› æ­¤ç¬”è€…é€‰æ‹©äº†å¼€ç®±å³ç”¨çš„ [tsup](https://github.com/egoist/tsup)ï¼š

```bash
yarn add -D tsup
```

æ·»åŠ  tsup çš„é…ç½®æ–‡ä»¶ `tsup.config.ts`ï¼š

```ts
import svg from "esbuild-plugin-svg";
import { defineConfig } from "tsup";

import packageJson from "./package.json";

export default defineConfig({
  entry: ["src/index.ts"],
  target: ["chrome107"],
  minify: false,
  splitting: false,
  clean: true,
  platform: "browser",
  esbuildPlugins: [svg()], // ä¸ºäº†æ­£ç¡®å¤„ç†é¡¹ç›®ä¸­ç”¨åˆ°çš„ SVG æ–‡ä»¶ï¼Œæ·»åŠ äº†æ­¤æ’ä»¶
  env: {
    VERSION: packageJson.version,
  },
  banner: {
    js: `// ==UserScript==
// @name                Pixiv Previewer L
// @namespace           ${packageJson.homepage}
// @version             ${packageJson.version}-${new Date().toLocaleDateString()}
// @description         ${packageJson.description}
// @author              ${packageJson.author}
// @license             ${packageJson.license}
// @supportURL          ${packageJson.homepage}
// @match               *://www.pixiv.net/*
// @grant               GM_getValue
// @grant               GM_setValue
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM.xmlHttpRequest
// @icon                https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=32&url=https://www.pixiv.net
// @icon64              https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=64&url=https://www.pixiv.net
// @require             https://update.greasyfork.org/scripts/515994/1478507/gh_2215_make_GM_xhr_more_parallel_again.js
// @require             http://code.jquery.com/jquery-3.7.1.min.js
// @run-at              document-end
// ==/UserScript==`,
  },
});
```

ä¸Šé¢çš„é…ç½®è¡¨ç¤ºï¼Œtsup å°†æ‰“åŒ…æ„å»ºæºæ–‡ä»¶ `src/index.ts` è‡³é»˜è®¤äº§ç‰©æ–‡ä»¶ `dist/index.js`ï¼Œä¿è¯å…¼å®¹ `Chrome >= 107`ã€‚å…¶ä¸­ï¼Œç¬”è€…å¤ç”¨äº† `package.json` é‡Œå®šä¹‰çš„è‹¥å¹²å­—æ®µï¼Œç”¨äºæ·»åŠ é¡¹ç›®ç¯å¢ƒå˜é‡ï¼ˆè„šæœ¬é€šè¿‡ç‰ˆæœ¬å·åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæ›´æ–°æ—¥å¿—æ¡†ï¼‰ï¼Œä»¥åŠç”Ÿæˆæ²¹çŒ´è„šæœ¬é¡¶éƒ¨çš„é…ç½®é¡¹ã€‚

è¿™æ ·ï¼Œå½“æ‰§è¡Œ `tsup` å‘½ä»¤æ—¶ï¼Œæ„å»ºçš„äº§ç‰©å½¢å¦‚ï¼š

```js
// ==UserScript==
// @name                Pixiv Previewer L
// @namespace           https://github.com/LolipopJ/PixivPreviewer
// @version             1.1.1-2025/4/25
// @description         Original project: https://github.com/Ocrosoft/PixivPreviewer.
// @author              Ocrosoft, LolipopJ
// @license             GPL-3.0
// @supportURL          https://github.com/LolipopJ/PixivPreviewer
// @match               *://www.pixiv.net/*
// @grant               GM_getValue
// @grant               GM_setValue
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM.xmlHttpRequest
// @icon                https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=32&url=https://www.pixiv.net
// @icon64              https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=64&url=https://www.pixiv.net
// @require             https://update.greasyfork.org/scripts/515994/1478507/gh_2215_make_GM_xhr_more_parallel_again.js
// @require             http://code.jquery.com/jquery-3.7.1.min.js
// @run-at              document-end
// ==/UserScript==

// ... è„šæœ¬æ„å»ºåçš„ä»£ç 
```

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œtsup ä¼šä½¿ç”¨é¢„è®¾çš„ `tsconfig.json`ã€‚ä½†ç¬”è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå‘ç° VSCode æœ‰æ—¶ä¼šé—æ¼æŸäº›ç±»å‹çš„å®šä¹‰ï¼Œäºæ˜¯æ‰‹åŠ¨æ·»åŠ äº† `tsconfig.json` åœ¨æ ¹ç›®å½•ï¼š

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "esnext",
    "esModuleInterop": true,
    "moduleResolution": "bundler",
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "lib": ["esnext", "dom"]
  },
  "include": ["src/"],
  "exclude": ["node_modules/", "dist/"]
}
```

### ä»£ç è´¨é‡æ£€æŸ¥ä¸æ ¼å¼åŒ–å·¥å…·

TypeScript è‡ªèº«å·²åŒ…å«ç±»å‹æ£€æŸ¥ç­‰èƒ½åŠ›ï¼Œä½†è¿˜å¯ä»¥å¼•å…¥æ›´å¤šè´¨é‡æ£€æŸ¥çš„é€šç”¨è§„èŒƒï¼Œæå‡é¡¹ç›®çš„å¥å£®æ€§ã€‚å¯¹äº TypeScript é¡¹ç›®ï¼Œç›®å‰æ¥çœ‹æœ€å¥½çš„é€‰æ‹©åº”å½“æ˜¯ [`typescript-eslint`](https://github.com/typescript-eslint/typescript-eslint)ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£æ·»åŠ ä¾èµ–å¹¶é…ç½® `eslint.config.mjs`ï¼š

```bash
yarn add --dev eslint @eslint/js typescript typescript-eslint
```

```js
// @ts-check

import eslint from "@eslint/js";
import tseslint from "typescript-eslint";

export default tseslint.config(
  eslint.configs.recommended,
  tseslint.configs.recommended,
);
```

ç°åœ¨æ‰§è¡Œ `eslint src --fix` å³å¯æŸ¥æ‰¾å¹¶å°è¯•ä¿®å¤ `src/` ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„è´¨é‡é—®é¢˜ã€‚

æ¥ç€ä¸ºé¡¹ç›®æ·»åŠ è‡ªåŠ¨æ ¼å¼åŒ–èƒ½åŠ›ï¼ŒPrettier æ˜¯ç¬”è€…æœ€æ¨èçš„é€‰é¡¹ã€‚æ­¤å¤–ï¼Œç¬”è€…å–œæ¬¢å°† Prettier ä¸ ESLint ç»“åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ï¼Œå³åœ¨æ‰§è¡Œ `eslint src --fix` ä¿®å¤è´¨é‡é—®é¢˜çš„åŒæ—¶ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ã€‚ESLint çš„æ’ä»¶ [`eslint-plugin-prettier`](https://github.com/prettier/eslint-plugin-prettier) å¯ä»¥å®ç°å¦‚ä¸Šèƒ½åŠ›ï¼Œæ·»åŠ æ­¤æ’ä»¶ä½œä¸ºä¾èµ–å¹¶è¿›ä¸€æ­¥é…ç½® `eslint.config.mjs`ï¼š

```bash
yarn add -D prettier eslint-plugin-prettier eslint-config-prettier
```

```js
// @ts-check

import eslint from "@eslint/js";
import tseslint from "typescript-eslint";
import eslintPluginPrettierRecommended from "eslint-plugin-prettier/recommended";

export default tseslint.config(
  eslint.configs.recommended,
  tseslint.configs.recommended,
  eslintPluginPrettierRecommended,
);
```

æ­¤å¤–ï¼ŒPixiv Previewer é¡¹ç›®ä¾èµ–äº JQuery æ¥æ‰§è¡ŒæŸ¥æ‰¾ä¸ä¿®æ”¹ DOM çš„æ“ä½œï¼Œç¬”è€…æ·»åŠ äº†ç›¸åº”çš„ç±»å‹æç¤ºï¼š

```bash
yarn add -D @types/jquery globals
```

```js
// @ts-check

import eslint from "@eslint/js";
import tseslint from "typescript-eslint";
import eslintPluginPrettierRecommended from "eslint-plugin-prettier/recommended";
import globals from "globals";

export default tseslint.config(
  eslint.configs.recommended,
  tseslint.configs.recommended,
  {
    languageOptions: {
      globals: {
        ...globals.browser,
        ...globals.jquery,
      },
    },
  },
  eslintPluginPrettierRecommended,
);
```

è‡³æ­¤ï¼ŒåŸºæœ¬çš„é¡¹ç›®å·¥ç¨‹åŒ–æ”¹é€ å‘Šä¸€æ®µè½ã€‚é¡¹ç›®å¯ä»¥åŸºäº TypeScript å¼€å‘ï¼Œå¹¶ä¸”æ‹¥æœ‰äº†è´¨é‡æ£€æŸ¥å’Œæ ¼å¼åŒ–èƒ½åŠ›ã€‚å°†åŸæ¥çš„ JavaScript ä»£ç æ”¾åˆ° `src/index.ts` æ–‡ä»¶é‡Œï¼Œå¼€å§‹æ­£å¼çš„äºŒæ¬¡å¼€å‘å§ï¼

## é¢„è§ˆåŠŸèƒ½ä¼˜åŒ–

ç¬”è€…åœ¨é˜…è¯» Pixiv Previewer æºç æ—¶å‘ç°ï¼ŒåŸä½œè€…æ ¹æ®å½“å‰é¡µé¢çš„ä¸åŒï¼Œå®ç°äº†ä¸åŒçš„é€šè¿‡ DOM èŠ‚ç‚¹å¯»æ‰¾å¯é¢„è§ˆä½œå“çš„ `<img>` æ ‡ç­¾çš„æ–¹æ³•ï¼Œå¹¶ä¸ºå®ƒæ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œå½“é¼ æ ‡æ‚¬æµ®åœ¨ä¸Šé¢çš„æ—¶å€™æ˜¾ç¤ºé¢„è§ˆã€‚ä¸ºäº†åº”å¯¹ä½œå“åŠ¨æ€åŠ è½½çš„æƒ…å†µï¼Œè„šæœ¬è®¾ç½®äº†å¾ªç¯å®šæ—¶å™¨ï¼Œæ¯éš”ä¸€å°æ®µæ—¶é—´é‡æ–°æ‰§è¡Œä¸Šè¿°æ–¹æ³•ã€‚

è¿™ç§åŠ›å¤§ç –é£çš„å®ç°æ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªä¸å¯å¿½è§†çš„ç¼ºé™·ï¼šè¦è€ƒè™‘åˆ°æ¯ä¸ªé¡µé¢é‡Œä¸åŒçš„ä½œå“ `<img>` æ ‡ç­¾çš„æ’å¸ƒæƒ…å†µï¼Œä¸ºä¹‹å®ç°ç»‘å®šäº‹ä»¶çš„æ–¹æ³•ã€‚å¯¹äºæ²¡æœ‰è€ƒè™‘åˆ°çš„ä½œå“ `<img>` æ ‡ç­¾ï¼Œè‡ªç„¶æ— æ³•æ˜¾ç¤ºé¢„è§ˆã€‚ä¾‹å¦‚ï¼Œåœ¨å½“å‰çš„ `Pixiv Previewer@3.7.32` ç‰ˆæœ¬ï¼Œè‰ºæœ¯å®¶å¼¹çª—é‡Œæœ€è¿‘çš„ä½œå“å°±æ— æ³•æ˜¾ç¤ºé¢„è§ˆï¼š

![è‰ºæœ¯å®¶æœ€è¿‘ä½œå“æš‚æœªå®ç°é¢„è§ˆåŠŸèƒ½](./pixiv-previewer/unimplemented-preview.png)

å¦å¤–ï¼Œå¦‚æœ Pixiv å‰ç«¯é¡µé¢æŸä¸€å¤©è¿­ä»£æ›´æ–°ï¼Œå¯»æ‰¾ä½œå“ `<img>` æ ‡ç­¾çš„æ–¹æ³•ä¹Ÿå¯èƒ½éœ€è¦å¤§åˆ€é˜”æ–§åœ°ä¿®æ”¹ã€‚

> å‘å¸ƒè¿™ç¯‡åšå®¢çš„ç¬¬äºŒå¤©ï¼Œ2025 å¹´ 03 æœˆ 18 æ—¥ï¼ŒPixiv å°±ä¸Šçº¿äº†æ–°çš„é¦–é¡µï¼Œâ€œæ¨èä½œå“â€æ¨¡å—çš„ä¸‹é¢å˜æˆäº†æ— é™æ»šåŠ¨çš„æ¨æ–‡æ¨¡å¼ã€‚ç”±äºæ¨æ–‡å­˜åœ¨é«˜åº¦ä¸Šé™ï¼Œå› æ­¤éƒ¨åˆ†å°ºå¯¸çš„å›¾ç‰‡è¿˜æ˜¯ä¼šå‡ºç°æ˜¾ç¤ºä¸å…¨çš„æƒ…å†µï¼Œå¯ä»¥æ·»åŠ é¢„è§ˆåŠŸèƒ½ã€‚

ç¬”è€…æƒ³åˆ°çš„æ”¹è¿›æ–¹æ¡ˆæ˜¯ï¼šæŠŠæ‰¾ä½œå“ `<img>` æ ‡ç­¾çš„å·¥ä½œï¼Œä»è„šæœ¬æ‰‹ä¸­ç§»äº¤åˆ°ç”¨æˆ·æ‰‹ä¸­ã€‚å³ç›‘å¬é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼Œå½“æ‚¬æµ®åˆ°å¯é¢„è§ˆä½œå“ä¸Šæ—¶ï¼Œæ˜¾ç¤ºé¢„è§ˆã€‚

```ts
const onMouseMove = (mouseMoveEvent: JQuery.MouseMoveEvent) => {
  onMouseOverIllust(mouseMoveEvent.target);
};

$(document).on("mousemove", onMouseMove);
```

åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œç¬”è€…ä¸º Document å…¨å±€ç»‘å®šäº† `mousemove` ç›‘å¬äº‹ä»¶ï¼Œå½“é¼ æ ‡ç§»åŠ¨æ—¶ï¼Œè°ƒç”¨ `onMouseOverIllust(target)` æ–¹æ³•ï¼Œå…¶ä¸­ `target` æ˜¯å½“å‰é¼ æ ‡æ‰€æ‚¬æµ®çš„å…ƒç´ ã€‚å¦‚æœç›‘å¬çš„æ˜¯ `mouseover` äº‹ä»¶ï¼Œè„šæœ¬å¯ä»¥æœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œä½†æ˜¯ç¬”è€…åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç° `mouseover` äº‹ä»¶å›è°ƒå¯¹è±¡é‡Œçš„ `ctrlKey` ç­‰å€¼æœ‰æ—¶ä¸èƒ½æ­£ç¡®åæ˜ å®é™…çŠ¶æ€ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©äº†ç›‘å¬ `mousemove` äº‹ä»¶ã€‚

æ¥ç€ï¼Œéœ€è¦åˆ¤æ–­é¼ æ ‡å½“å‰æ‚¬æµ®çš„å…ƒç´ æ˜¯å¦ä¸ºå¯é¢„è§ˆçš„ä½œå“ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºé¢„è§ˆã€‚è§‚å¯Ÿ DOM èŠ‚ç‚¹ï¼š

![ä½œå“ DOM èŠ‚ç‚¹](./pixiv-previewer/hovered-illust.png)

å¦‚æœå½“å‰é¼ æ ‡æ‚¬æµ®åœ¨å¯é¢„è§ˆçš„ä½œå“ `<img>` å…ƒç´ ä¸Šï¼Œåˆ™æœ¬èº«åŒ…å«äº†è®¿é—®é“¾æ¥çš„ `src` å±æ€§ï¼Œé€šè¿‡ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼å¤„ç†å³å¯è·å–ä½œå“çš„ Pixiv ID å’Œå¤§å›¾é“¾æ¥ã€‚åŒæ—¶ï¼Œå¤–å±‚è¿˜åŒ…è£¹ç€ä¸€å±‚ `<a>` å…ƒç´ ï¼ŒåŒ…å«è·³è½¬é“¾æ¥ã€‚

è€ƒè™‘åˆ°éƒ¨åˆ† `<img>` å…ƒç´ è™½ç„¶åŒ…å«ä½œå“ç¼©ç•¥å›¾çš„ `src` å±æ€§ï¼Œä½†è·³è½¬çš„é¡µé¢å¹¶ä¸ä¸€å®šæ˜¯ä½œå“é¡µæœ¬èº«ï¼ˆ`https://www.pixiv.net/artworks/artwork-id`ï¼‰ï¼Œå³å¯èƒ½åªæ˜¯ä½œä¸ºå°é¢æ‰“å¼€åˆ«çš„é¡µé¢ï¼Œé¼ æ ‡æ‚¬æµ®åœ¨è¿™äº› `<img>` å…ƒç´ ä¸Šæ—¶ä¸åº”å½“æ˜¾ç¤ºé¢„è§ˆã€‚å› æ­¤ç¬”è€…å®ç°çš„åˆ¤æ–­æ–¹æ³•æ˜¯ï¼šç»Ÿä¸€å–å½“å‰æ‚¬æµ®å…ƒç´ çš„ç¬¬ä¸€ä¸ªçˆ¶ `<a>` èŠ‚ç‚¹ï¼Œå½“å…¶ `href` å€¼æ»¡è¶³ `/\/artworks\/(\d+)/` æ—¶ï¼Œæ˜¾ç¤ºé¢„è§ˆï¼š

```ts
const getIllustMetadata = (target: JQuery<HTMLElement>) => {
  let imgLink = target;
  while (!imgLink.is("A")) {
    imgLink = imgLink.parent();

    if (!imgLink.length) {
      return null;
    }
  }

  const illustHref = imgLink.attr("href");
  const illustHrefMatch = illustHref?.match(/\/artworks\/(\d+)/);
  if (!illustHrefMatch) {
    return null;
  }
  const illustId = illustHrefMatch[1];

  const ugoiraSvg = imgLink.children("div:first").find("svg:first");
  const illustType =
    ugoiraSvg.length || imgLink.hasClass("ugoku-illust")
      ? IllustType.UGOIRA // åŠ¨å›¾ä½œå“
      : IllustType.ILLUST; // æ’ç”»æˆ–æ¼«ç”»ä½œå“

  return {
    /** ä½œå“ ID */
    illustId,
    /** ä½œå“ç±»å‹ */
    illustType,
  };
};

const onMouseOverIllust = (target: JQuery<HTMLElement>) => {
  const { illustId, illustType } = getIllustMetadata(target) || {};
  previewIllust({ target, illustId, illustType });
};
```

æ’ç”»æˆ–æ¼«ç”»ä½œå“å¯èƒ½å­˜åœ¨å¤šé¡µï¼Œå¤„ç†æ—¶å¯ä»¥å§‹ç»ˆè°ƒç”¨ Pixiv å®˜æ–¹çš„æ¥å£ `/ajax/illust/${artwork-id}/pages`ï¼Œè·å–æŒ‡å®šä½œå“åŒ…å«çš„æ‰€æœ‰é“¾æ¥ã€‚

å†ä¿®ä¿®è¡¥è¡¥ï¼Œä¸ºäº‹ä»¶åŠ ä¸ŠèŠ‚æµå‡½æ•°ï¼Œå“åº”é¼ æ ‡æ»šåŠ¨åˆ‡æ¢é¡µæ•°ç­‰ï¼Œå®ç°äº†å’ŒåŸç‰ˆå¹¶æ— äºŒå¼‚çš„é¢„è§ˆèƒ½åŠ›ï¼š

![Pixiv é¢„è§ˆ](./pixiv-previewer/previewer.png)

å¯å–œå¯è´ºï¼Œå¯å–œå¯è´ºï¼

## æ’åºåŠŸèƒ½é‡æ„ä¸ä¼˜åŒ–

åŸè„šæœ¬çš„é¢„è§ˆåŠŸèƒ½å·²ç»èƒ½å¤Ÿéå¸¸å¥½åœ°å®ç°ç¬”è€…éœ€è¦çš„èƒ½åŠ›äº†ï¼Œç¬”è€…æƒ³è¦åœ¨æ­¤åŸºç¡€ä¸ŠåŠ å…¥ä¸€äº›é¢å¤–çš„èƒ½åŠ›æˆ–åšä¸€äº›ä¼˜åŒ–ã€‚

å…¶å®æœ€å¼€å§‹çš„åŸåŠ¨åŠ›æ¥è‡ªäºåŸè„šæœ¬åœ¨æŸæ¬¡æ›´æ–°ä»¥åï¼Œæ’åºåŠŸèƒ½çªç„¶å˜å¾—å¾ˆæ…¢ï¼Œè¿‡å»ç¬”è€…ä¸€æ¬¡æ€§å–œæ¬¢æ’åº 20 é¡µä½œå“å†æŒ‘é€‰å–œæ¬¢çš„ï¼Œç°åœ¨å´è¦å…ˆç­‰ä¸ªäºŒååˆ†é’Ÿï¼Œè¿˜å¯èƒ½â€œä¸­é“å´©æ®‚â€ã€‚åé¢çœ‹å…¬å‘Šæ‰äº†è§£åˆ°ï¼ŒPixiv ä»æŸå¤©å¼€å§‹å¯¹æ¥è‡ªäºåŒ IP çš„è¯·æ±‚è¿›è¡Œäº†é™åˆ¶ï¼Œå¦‚æœçŸ­æ—¶é—´å†…è¶…è¿‡äº†è¯·æ±‚çš„ä¸Šé™ï¼Œåˆ™ä¼šæš‚æ—¶å±è”½è¯·æ±‚ã€‚è¿™ç‚¹å¯¹äº Pixiv æ¥è¯´æ— å¯åšéï¼Œèƒ½å¤§å¤§ç¼“è§£åƒç¬”è€…è¿™æ ·çš„æœåŠ¡å™¨è›€è™«çš„â€œæ”»å‡»â€ã€‚

äºæ˜¯ä¾¿å¼€å§‹äº†æœ¬ä»¥ä¸ºæ— é™æœŸçš„å’•å’•å’•ï¼Œä½†æœ€è¿‘ä»£ç å†™å¾—æ‰‹æ„Ÿç«çƒ­ï¼Œæƒ³åˆ°äº†è¿™ä¸ªå‘ï¼Œå°±èŠ±äº†å‡ å¤©å¡«ä¸€å¡«ã€‚åŒæ—¶ä¹Ÿå¤šæ¥è§¦æ¥è§¦åŸç”Ÿ DOM æ“ä½œç­‰å°çŸ¥è¯†ï¼Œç™¾åˆ©æ— ä¸€å®³ã€‚

### è¯·æ±‚ä½œå“åˆ†é¡µ

æ’åºåŠŸèƒ½çš„æœ¬è´¨å°±æ˜¯åŒæ—¶è¯·æ±‚å¤šä¸ªåˆ†é¡µï¼Œå†è·å–æ¯ä¸ªä½œå“çš„è¯¦ç»†ä¿¡æ¯ï¼Œæœ€ååœ¨å‰ç«¯æ˜¾ç¤ºå‡ºæ¥ã€‚ä¸‹é¢ä»¥æ ‡ç­¾æœç´¢ç»“æœçš„é¡µé¢ä¸ºä¾‹ï¼Œå®ç°æ’åºåŠŸèƒ½ã€‚

å¯¹äºä¸åŒçš„å¯æ’åºé¡µé¢ï¼Œéœ€è¦è·å–çš„è¦ç´ æœ‰ä¸‰ï¼š

- è¯·æ±‚åˆ†é¡µçš„æ¥å£ã€‚
- è¯·æ±‚åˆ†é¡µçš„å‚æ•°ã€‚
- ä½œå“çš„åˆ—è¡¨ DOM èŠ‚ç‚¹ã€‚

ä½¿ç”¨è§‚å¯Ÿæ³•ï¼Œåœ¨ç½‘ç»œè¯·æ±‚é‡Œæ‰¾åˆ°åˆ†é¡µçš„æ¥å£ä¸é»˜è®¤çš„æœç´¢å‚æ•°ï¼š

```ts
function getSortOptionsFromPathname(pathname: string) {
  let type: IllustSortType;
  let api: string;
  let defaultSearchParams: string;

  let match: RegExpMatchArray;
  if (
    (match = pathname.match(/\/tags\/(.+)\/(artworks|illustrations|manga)$/))
  ) {
    const tagName = match[1];
    const filterType = match[2];

    switch (filterType) {
      case "artworks":
        type = IllustSortType.TAG_ARTWORK;
        api = `/ajax/search/artworks/${tagName}`;
        defaultSearchParams = `word=${tagName}&order=date_d&mode=all&p=1&csw=0&s_mode=s_tag_full&type=all&lang=zh`;
        break;
      case "illustrations":
        type = IllustSortType.TAG_ILLUST;
        api = `/ajax/search/illustrations/${tagName}`;
        defaultSearchParams = `word=${tagName}&order=date_d&mode=all&p=1&csw=0&s_mode=s_tag_full&type=illust_and_ugoira&lang=zh`;
        break;
      case "manga":
        type = IllustSortType.TAG_MANGA;
        api = `/ajax/search/manga/${tagName}`;
        defaultSearchParams = `word=${tagName}&order=date_d&mode=all&p=1&csw=0&s_mode=s_tag_full&type=manga&lang=zh`;
        break;
    }
  }

  return {
    type,
    api,
    searchParams: new URLSearchParams(defaultSearchParams),
  };
}
```

å½“ç”¨æˆ·åœ¨å‰ç«¯è®¾ç½®æœç´¢æ¡ä»¶çš„æ—¶å€™ï¼Œæœç´¢æ¡ä»¶ä¼šè‡ªåŠ¨è¿½åŠ åˆ°å½“å‰çš„ Search Params ä¸Šã€‚è„šæœ¬åœ¨å¤„ç†çš„æ—¶å€™ï¼Œä¹Ÿåº”è¯¥è¯»å– Search Paramsï¼Œå†ä¸æ–¹æ³• `getSortOptionsFromPathname()` å¾—åˆ°çš„é»˜è®¤ `searchParams` è¿›è¡Œåˆå¹¶ï¼Œè®©æ¥å£è¯·æ±‚ç¬¦åˆç”¨æˆ·é¢„æœŸï¼š

```ts
const url = new URL(location.href);
const { pathname, searchParams } = url;

const {
  type,
  api,
  searchParams: defaultSearchParams,
} = getSortOptionsFromPathname(pathname);

const mergedSearchParams = new URLSearchParams(defaultSearchParams);
searchParams.forEach((value, key) => {
  // ç›¸åŒå‚æ•°è¦†ç›–ï¼Œä¸åŒå‚æ•°è¿½åŠ 
  mergedSearchParams.set(key, value);
});
```

æ¥ç€ï¼Œè·å–é™ˆåˆ—ä½œå“çš„åˆ—è¡¨ DOM èŠ‚ç‚¹ï¼š

```ts
function getIllustrationsListDom(type: IllustSortType) {
  let dom: JQuery<HTMLUListElement>;
  if (
    [
      IllustSortType.TAG_ARTWORK,
      IllustSortType.TAG_ILLUST,
      IllustSortType.TAG_MANGA,
    ].includes(type)
  ) {
    dom = $("ul.sc-ad8346e6-1.iwHaa-d");
  }

  if (dom) {
    return dom;
  } else {
    throw new Error(`Illustrations list DOM not found.`);
  }
}
```

Pixiv çš„å‰ç«¯ä½¿ç”¨äº† CSS Module æŠ€æœ¯æ¥ç”Ÿæˆæ ·å¼åï¼Œèƒ½å¤Ÿæœ‰æ•ˆé¿å…åŒåæ ·å¼å†²çªçš„é—®é¢˜ã€‚ä½†æ˜¯å¯¹äºè„šæœ¬å¼€å‘è€…æ¥è¯´ä¼šå¢åŠ ä¸€å®šçš„ç»´æŠ¤æˆæœ¬ â€”â€” æ¯æ¬¡ Pixiv çš„æ ·å¼æ”¹å˜è€Œé‡æ–°æ„å»ºæ ·å¼æ–‡ä»¶æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨æ›´æ–°è„šæœ¬é‡Œå¯¹åº”çš„æ ·å¼åï¼Œä»¥æ­£ç¡®æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

å› æ­¤åœ¨å®ç°é‡Œï¼Œå½“è„šæœ¬å¯»æ‰¾èŠ‚ç‚¹å¤±è´¥æ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œé˜»æ­¢è„šæœ¬çš„ç»§ç»­è¿è¡Œã€‚ä½œä¸ºå¼€å‘è€…ï¼Œåœ¨ç¢°åˆ°è¿™æ ·çš„é—®é¢˜æ—¶ï¼Œå°±å¾—èµ¶ç´§æ›´æ–°è„šæœ¬ï¼Œæˆ–è€…æƒ³ä¸€æƒ³æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹å¼èƒ½å®šä½æ­¤èŠ‚ç‚¹ï¼ˆä¾‹å¦‚æœç´¢åŒ…å« 60 ä¸ªå­å…ƒç´ çš„ `ul` èŠ‚ç‚¹ ğŸ¤”ï¼‰ã€‚

### è·å–ä½œå“è¯¦ç»†ä¿¡æ¯

ä¸ºäº†è·å–ä½œå“çš„æ”¶è—æ•°æ®ä»¥æ’åºï¼Œéœ€è¦é€šè¿‡å¦å¤–çš„æ¥å£è·å–ä½œå“çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚æœè¯·æ±‚åˆ†é¡µçš„æ—¶å€™ï¼Œå“åº”å€¼å°±æŠŠä½œå“çš„æ”¶è—æ•°å¸¦ä¸Šå°±å¥½äº†â€¦â€¦ï¼‰ã€‚

è¿™é‡Œç›´æ¥æ²¿ç”¨äº†åŸä½œè€…ä½¿ç”¨çš„æ¥å£ `/touch/ajax/illust/details?illust_id=${id}`ï¼š

```ts
async function getIllustrationDetailsWithCache(id: string) {
  let illustDetails: IllustrationDetails =
    await getCachedIllustrationDetails(id);

  if (illustDetails) {
    iLog.d(`Use cached details for illustration ${id}`, illustDetails);
  } else {
    const requestUrl = `/touch/ajax/illust/details?illust_id=${id}`;
    const getIllustDetailsRes = await requestWithRetry({
      url: requestUrl,
      onRetry: (response, retryTimes) => {
        iLog.w(
          `Get illustration details through \`${requestUrl}\` failed:`,
          response,
          `${retryTimes} times retrying...`,
        );
      },
    });
    illustDetails = (
      getIllustDetailsRes.response as PixivStandardResponse<{
        illust_details: IllustrationDetails;
      }>
    ).body.illust_details;
  }

  cacheIllustrationDetails(illustDetails);

  return illustDetails;
}
```

åœ¨æ­¤åŸºç¡€ä¸Šåšäº†ä¸¤ä¸ªé¢å¤–çš„å·¥ä½œã€‚å…¶ä¸€æ˜¯ç¼“å­˜ä½œå“è¯¦ç»†ä¿¡æ¯ï¼šå¯¹äºå‘å¸ƒæ—¶é—´è¶…è¿‡ 6 å°æ—¶çš„ä½œå“ï¼Œæˆ‘ä»¬è®¤ä¸ºä½œå“çš„æ”¶è—æ•°å˜åŒ–ç‡ä¼šè¶‹äºå¹³ç¨³ï¼Œåˆ™å°†ä½œå“çš„è¯¦ç»†ä¿¡æ¯ç¼“å­˜ 12 å°æ—¶ã€‚12 å°æ—¶å†…å†è·å–æ­¤ä½œå“çš„è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œç›´æ¥ä» Indexed DB é‡Œæ‹¿ã€‚çœç•¥ Indexed DB åˆå§‹åŒ–å’Œé”™è¯¯å¤„ç†ç­‰é€»è¾‘ï¼Œæ ¸å¿ƒå®ç°å¦‚ä¸‹ï¼š

```ts
/** ç¼“å­˜æ•°æ®è¡¨åç§° */
const ILLUSTRATION_DETAILS_CACHE_TABLE_KEY = "illustrationDetailsCache";
/** ç¼“å­˜è¿‡æœŸæ—¶é—´ */
const ILLUSTRATION_DETAILS_CACHE_TIME = 1000 * 60 * 60 * 12; // 12 å°æ—¶
/** ä¸æ·»åŠ ç¼“å­˜çš„æ–°ä½œå“å‘å¸ƒæ—¶é—´ */
const NEW_ILLUSTRATION_NOT_CACHE_TIME = 1000 * 60 * 60 * 6; // 6 å°æ—¶

/** ç¼“å­˜ä½œå“è¯¦ç»†ä¿¡æ¯ */
const cacheIllustrationDetails = (
  illustration: IllustrationDetails,
  now: Date = new Date(),
) => {
  return new Promise<void>(() => {
    const cachedIllustrationDetailsObjectStore = db
      .transaction(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY, "readwrite")
      .objectStore(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY);

    const createDate = new Date(illustration.createDate);

    if (
      now.getTime() - createDate.getTime() >
      NEW_ILLUSTRATION_NOT_CACHE_TIME
    ) {
      // ä½œå“å‘å¸ƒè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œæ·»åŠ ç¼“å­˜
      const illustrationDetails: IllustrationDetailsCache = {
        ...illustration,
        cacheDate: now,
      };
      // è¿™é‡Œç®€å•å¤„ç†ï¼Œå¦‚æœæ•°æ®åº“é‡Œå·²ç»åŒ…å«ç¼“å­˜æ•°æ®ï¼Œåˆ™é‡æ–°è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 12 å°æ—¶
      // å½“ç„¶ï¼Œæ›´åˆç†çš„æ–¹å¼æ˜¯å­˜åœ¨æ—¶è·³è¿‡ï¼Œä¸é‡æ–°è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
      const addCachedIllustrationDetailsRequest =
        cachedIllustrationDetailsObjectStore.put(illustrationDetails);
    }
  });
};

/** è·å–ä½œå“è¯¦ç»†ä¿¡æ¯ç¼“å­˜ */
const getCachedIllustrationDetails = (id: string, now: Date = new Date()) => {
  return new Promise<IllustrationDetailsCache | undefined>((resolve) => {
    const cachedIllustrationDetailsObjectStore = db
      .transaction(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY, "readwrite")
      .objectStore(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY);

    const getCachedIllustrationDetailsRequest =
      cachedIllustrationDetailsObjectStore.get(id);

    getCachedIllustrationDetailsRequest.onsuccess = (event) => {
      const illustrationDetails = (
        event.target as IDBRequest<IllustrationDetailsCache | undefined>
      ).result;
      if (illustrationDetails) {
        const { cacheDate } = illustrationDetails;
        if (
          now.getTime() - cacheDate.getTime() <=
          ILLUSTRATION_DETAILS_CACHE_TIME
        ) {
          // ç¼“å­˜æœªè¿‡æœŸï¼Œè¿”å›ç¼“å­˜ç»“æœ
          resolve(illustrationDetails);
        }
      }
      resolve(undefined);
    };
  });
};
```

è®¾ç½®ç¼“å­˜çš„ä¸»è¦ç›®çš„æ˜¯å‡å°‘è¢« Pixiv é™åˆ¶è¯·æ±‚çš„å¯èƒ½æ€§ï¼Œä¹Ÿä¾¿äºå¼€å‘æµ‹è¯•ã€‚

ç¬¬äºŒä¸ªé¢å¤–çš„å·¥ä½œæ˜¯ï¼šä¸ºè·å–ä½œå“è¯¦ç»†ä¿¡æ¯çš„è¯·æ±‚æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶ï¼Œé¿å…å›  Pixiv é™åˆ¶å¼•èµ·çš„æ’åºåŠŸèƒ½å¤±æ•ˆã€‚è¿™ä¸€ç‚¹é€šè¿‡å°è£…è¯·æ±‚æ–¹æ³•å®ç°ï¼š

```ts
const xmlHttpRequest = window.GM.xmlHttpRequest;

/** æ ‡å‡†çš„è¯·æ±‚æ–¹æ³• */
export const request = <TContext = unknown>(
  options: Tampermonkey.Request<TContext>,
) => {
  const { headers, ...restOptions } = options;
  return xmlHttpRequest<TContext>({
    responseType: "json",
    ...restOptions,
    headers: {
      referer: "https://www.pixiv.net/",
      ...headers,
    },
  });
};

/** å°è£…äº†é”™è¯¯é‡è¯•æœºåˆ¶çš„è¯·æ±‚æ–¹æ³• */
export const requestWithRetry = async <TContext = unknown>(
  options: Tampermonkey.Request<TContext> & {
    /** é‡è¯•é—´éš”æ—¶é—´ï¼ˆmsï¼‰ */
    retryDelay?: number;
    /** æœ€å¤§é‡è¯•æ¬¡æ•° */
    maxRetryTimes?: number;
    /** é‡è¯•å›è°ƒ */
    onRetry?: (
      response: Tampermonkey.Response<TContext>,
      retryTimes: number,
    ) => void;
  },
) => {
  const {
    retryDelay = 10000,
    maxRetryTimes = Infinity,
    onRetry,
    ...restOptions
  } = options;

  let response: Tampermonkey.Response<TContext>;
  let retryTimes = 0;
  while (retryTimes < maxRetryTimes) {
    response = await request<TContext>(restOptions);

    if (response.status === 200) {
      const responseData = response.response as PixivStandardResponse<unknown>;
      if (!responseData.error) {
        return response;
      }
    }

    retryTimes += 1;
    onRetry?.(response, retryTimes);
    await pause(retryDelay);
  }
  throw new Error(
    `Request for ${restOptions.url} failed: ${response.responseText}`,
  );
};
```

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼Œé‚£ä¹ˆä¼šé—´éš” 10s é‡æ–°å‘èµ·ç›¸åŒè¯·æ±‚ï¼Œé‡è¯•çš„æ¬¡æ•°æ— ä¸Šé™ã€‚ç›´åˆ°è¯·æ±‚è·å¾—æˆåŠŸå“åº”å€¼æ—¶ï¼Œè¿”å›å“åº”çš„ç»“æœã€‚

æœ€åï¼Œå®ç°å¹¶å‘è¯·æ±‚çš„èƒ½åŠ›ï¼š

```ts
export const execLimitConcurrentPromises = async <T>(
  promises: (() => Promise<T>)[],
  limit = 48,
) => {
  const results: T[] = [];
  let index = 0;

  const executeNext = async () => {
    if (index >= promises.length) return Promise.resolve();

    const currentIndex = index++;
    const result = await promises[currentIndex]();
    results[currentIndex] = result;
    return await executeNext();
  };

  const initialPromises = Array.from(
    { length: Math.min(limit, promises.length) },
    () => executeNext(),
  );

  await Promise.all(initialPromises);
  return results;
};

const getDetailedIllustrationPromises: (() => Promise<IllustrationDetails>)[] =
  [];
for (let i = 0; i < illustrations.length; i += 1) {
  getDetailedIllustrationPromises.push(async () => {
    const illustration = illustrations[i];
    const illustrationId = illustration.id;
    const illustrationDetails =
      await getIllustrationDetailsWithCache(illustrationId);
    return {
      ...illustration,
      bookmark_user_total: illustrationDetails.bookmark_user_total,
    } as IllustrationDetails;
  });
}
const detailedIllustrations = await execLimitConcurrentPromises(
  getDetailedIllustrationPromises,
);
```

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè„šæœ¬ä¼šå‘èµ·è‡³å¤š 48 ä¸ªè·å–ä½œå“è¯¦ç»†ä¿¡æ¯çš„å¹¶å‘è¯·æ±‚ï¼Œæå‡æ’åºåŠŸèƒ½çš„å¤„ç†æ•ˆç‡ã€‚è€Œä¸”ç»æµ‹è¯•ï¼Œå¹¶å‘èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šâ€œç»•è¿‡â€é£æ§æœºåˆ¶ï¼Œè‡³å°‘åœ¨é¦–æ¬¡å®Œæˆæ’åºæ—¶ï¼Œä¸ä¼šè¢«é™åˆ¶è¯·æ±‚ã€‚åªæ˜¯ç»“æŸåï¼ŒPixiv çš„æœåŠ¡å™¨â€œååº”è¿‡æ¥â€äº†ï¼Œå°±ä¼šè¢«å…³å‡ åˆ†é’Ÿå°é»‘å±‹äº† ğŸ˜¿ã€‚

å…³äºå¹¶å‘è¯·æ±‚åŠŸèƒ½ï¼Œå€¼å¾—è¡¥å……çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äº [Chrome MV3 issue](https://github.com/w3c/webextensions/issues/694)ï¼Œç¬”è€…å‚è€ƒåŸä½œè€…çš„å¤„ç†ï¼Œå¼•å…¥äº†ä¿®å¤è„šæœ¬ `https://update.greasyfork.org/scripts/515994/1478507/gh_2215_make_GM_xhr_more_parallel_again.js` ä½¿å¾—å¹¶è¡Œè¯·æ±‚åŠŸèƒ½ç”Ÿæ•ˆã€‚

### å‰ç«¯å±•ç¤ºä½œå“

æ ¹æ®æ¡ä»¶è¿‡æ»¤ä½œå“å’Œæ’åºä½œå“çš„è¿‡ç¨‹è·³è¿‡ä¸è¡¨ï¼Œç›´æ¥æ¥åˆ°æœ€åå±•ç¤ºä½œå“çš„ç¯èŠ‚ï¼

```ts
class IllustrationsSorter {
  type: IllustSortType;
  illustrations: IllustrationDetails[];
  listElement: JQuery<HTMLUListElement>;

  constructor() {
    // ...
    this.showIllustrations();
  }

  showIllustrations() {
    const fragment = document.createDocumentFragment();
    for (const {
      aiType,
      alt,
      bookmarkData,
      bookmark_user_total,
      id,
      illustType,
      pageCount,
      profileImageUrl,
      tags,
      title,
      url,
      userId,
      userName,
    } of this.illustrations) {
      const isUgoira = illustType === IllustType.UGOIRA;

      const listItem = document.createElement("li");

      const container = document.createElement("div");
      container.style = "width: 184px;";

      const illustrationAnchor = document.createElement("a");
      illustrationAnchor.setAttribute("data-gtm-value", id);
      illustrationAnchor.setAttribute("data-gtm-user-id", userId);
      illustrationAnchor.href = `/artworks/${id}`;
      illustrationAnchor.target = "_blank";
      illustrationAnchor.rel = "external";
      illustrationAnchor.style =
        "display: block; position: relative; width: 184px;";

      const illustrationImageWrapper = document.createElement("div");
      illustrationImageWrapper.style =
        "position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;";

      const illustrationImage = document.createElement("img");
      illustrationImage.src = url;
      illustrationImage.alt = alt;
      illustrationImage.style =
        "object-fit: cover; object-position: center center; width: 100%; height: 100%; border-radius: 4px; background-color: rgb(31, 31, 31);";

      const ugoriaSvg = document.createElement("div");
      ugoriaSvg.style = "position: absolute;";
      ugoriaSvg.innerHTML = playIcon;

      const illustrationMeta = document.createElement("div");
      illustrationMeta.style =
        "position: absolute; top: 0px; left: 0px; right: 0px; display: flex; align-items: flex-start; padding: 4px 4px 0; pointer-events: none; font-size: 10px;";
      illustrationMeta.innerHTML = `
          ${
            pageCount > 1
              ? `
                <div style="margin-left: auto;">
                  <div style="display: flex; justify-content: center; align-items: center; height: 20px; min-width: 20px; color: rgb(245, 245, 245); font-weight: bold; padding: 0px 6px; background: rgba(0, 0, 0, 0.32); border-radius: 10px; line-height: 10px;">
                    ${pageIcon}
                    <span>${pageCount}</span>
                  </div>
                </div>`
              : ""
          }
        `;

      const illustrationToolbar = document.createElement("div");
      illustrationToolbar.style =
        "position: absolute; top: 154px; left: 0px; right: 0px; display: flex; align-items: center; padding: 0 4px 4px; pointer-events: none; font-size: 12px;";
      // Mock: æš‚æœªå®ç°ç‚¹å‡»çˆ±å¿ƒæ”¶è— / å–æ¶ˆæ”¶è—çš„åŠŸèƒ½
      illustrationToolbar.innerHTML = `
          <div style="padding: 0px 4px; border-radius: 4px; color: rgb(245, 245, 245); background: ${bookmark_user_total > 50000 ? "#9f1239" : bookmark_user_total > 10000 ? "#dc2626" : bookmark_user_total > 5000 ? "#1d4ed8" : bookmark_user_total > 1000 ? "#15803d" : "#475569"}; font-weight: bold; line-height: 16px; user-select: none;">â¤ ${bookmark_user_total}</div>
          <div style="margin-left: auto;">${bookmarkData ? heartFilledIcon : heartIcon}</div>
        `;

      const illustrationTitle = document.createElement("div");
      illustrationTitle.innerHTML = title;
      illustrationTitle.style =
        "margin-top: 4px; max-width: 100%; overflow: hidden; text-decoration: none; text-overflow: ellipsis; white-space: nowrap; line-height: 22px; font-size: 14px; font-weight: bold; color: rgb(245, 245, 245); transition: color 0.2s;";

      const illustrationAuthor = document.createElement("a");
      illustrationAuthor.setAttribute("data-gtm-value", userId);
      illustrationAuthor.href = `/users/${userId}`;
      illustrationAuthor.target = "_blank";
      illustrationAuthor.rel = "external";
      illustrationAuthor.style =
        "display: flex; align-items: center; margin-top: 4px;";
      illustrationAuthor.innerHTML = `
          <img src="${profileImageUrl}" alt="${userName}" style="object-fit: cover; object-position: center top; width: 24px; height: 24px; border-radius: 50%; margin-right: 4px;">
          <span style="min-width: 0px; line-height: 22px; font-size: 14px; color: rgb(214, 214, 214); text-decoration: none; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">${userName}</span>
        `;

      illustrationImageWrapper.appendChild(illustrationImage);
      if (isUgoira) illustrationImageWrapper.appendChild(ugoriaSvg);
      illustrationAnchor.appendChild(illustrationImageWrapper);
      illustrationAnchor.appendChild(illustrationMeta);
      illustrationAnchor.appendChild(illustrationToolbar);
      illustrationAnchor.appendChild(illustrationTitle);
      container.appendChild(illustrationAnchor);
      container.appendChild(illustrationAuthor);
      listItem.appendChild(container);
      fragment.appendChild(listItem);
    }

    this.listElement.find("li").remove();
    this.listElement.append(fragment);
  }
}
```

åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œç¬”è€…å‚è€ƒ Pixiv ä½œå“èŠ‚ç‚¹çš„ DOMï¼Œæ‰‹åŠ¨æ„é€ äº†å¤§æŠµä¸€è‡´çš„ä½œå“èŠ‚ç‚¹ï¼Œå°½ç®¡éƒ¨åˆ†åŠŸèƒ½ç¼ºå¤±ï¼Œä½†èƒ½å¤Ÿæ»¡è¶³æ’åºä½œå“çš„éœ€è¦ã€‚ç¬”è€…ä¹Ÿè€ƒè™‘è¿‡å…‹éš†åŸç”ŸèŠ‚ç‚¹å†ä¿®æ”¹ DOM èŠ‚ç‚¹é‡Œçš„å±æ€§ä¼šå¦æ›´å¥½ï¼Œä½†æ˜¯å¿§å¿ƒå‰ç«¯ç‰ˆæœ¬æ›´æ–°å¯¼è‡´ DOM èŠ‚ç‚¹ç»“æ„æ›´æ–°ï¼Œä»¥åŠæ‹…å¿ƒä¸åŒé¡µé¢çš„ DOM èŠ‚ç‚¹ç»“æ„ä¸åŒï¼Œæ‰€ä»¥è¿˜æ˜¯äººå·¥æå‡ºæ¥äº†é€šç”¨èŠ‚ç‚¹ã€‚

æœ€åï¼Œåœ¨æƒ³è¦æ’åºçš„é¡µé¢ç‚¹å‡»æŒ‰é’®ï¼Œçœ‹çœ‹å¤§å®¶éƒ½çˆ±ä»€ä¹ˆä½œå“å§ï¼

![æ’åºåŒ…å«â€œå¤©ç«¥çˆ±ä¸½ä¸â€æ ‡ç­¾çš„ä½œå“](./pixiv-previewer/sorting-result.png)

## æœ€å

é™„ä¸Š [Github ä»“åº“åœ°å€](https://github.com/LolipopJ/PixivPreviewerL)ä¸ [Tampermonkey è„šæœ¬åœ°å€](https://greasyfork.org/zh-CN/scripts/533844)ï¼Œå¸Œæœ›å¯¹æœ‰ç±»ä¼¼éœ€æ±‚çš„äººå¸¦æ¥ä¸€äº›å¸®åŠ©ã€‚
